import matplotlib.pyplot as plt
import pandas as pd
import datetime as dt
import numpy as np
import numpy.polynomial.polynomial as poly
from matplotlib.offsetbox import AnchoredText

#blacklist = ["0","BEPre","BJPre", "DCPreN1", "HAPreN1", "HWPreN7","LKPreN6", "SBPre","SJPreN2","SWPre", "SWPreN1"]
volume_cc = [0.543989,0.307469,0.270602,0.294556,0.113893,0.105675,0.086302,2.793354,3.754931,3.464973,2.885628,2.407288,0.955745,0.515751,0.587344,0.760665,0.317817,0.336014,0.026839,0.840198,24.80681,24.81538,1.214741,0.069002,1.330683,0.865402,6.217733,8.838524,22.29957,13.45396,5.293841,11.31172,1.287479,0.517282,0.134989,0.298215,0.281392,0.25157,0.254139,0.826999,0.376701,0.364232,14.58643,10.30087,11.88325,12.84121,16.79919,15.44599,12.89173,0.934294,0.430711,0.318178,0.470876,0.337972,0.318074,1.900194,1.828563,17.52965,11.12782,10.58354,9.555532,9.410438,12.20094,1.509109,1.098115,1.31549,1.204187,1.077141,1.208082,1.279293,1.21951,0.65565,0.901221,2.186296,1.130676,0.804662,0.729812,0.669171,0.707358,1.391828,0.6368,0.876609,0.60598,0.656037,0.750328,0.166734,0.059049,56.04538,4.793916,3.970056,3.765012,3.471913,2.981021,2.623494,12.80783,7.25507,7.851116,10.72525,4.96983,4.794593,5.309189,6.638619,0.790063,0.173439,0.012722,0.007643,0.009741,0.026178,0.021006,0.848025,1.655571,0.698129,1.212755,1.084803,0.84129,0.720527,0.927787,1.936296,0.80734,2.070896,1.769047,4.054928,0.640349,0.621673,0.38552,0.233815,0.194337,0.334552,16.10505,12.8423,2.543108,2.50403,2.170324,5.501503,4.873517,1.400708,3.372005,2.84035,2.397581,2.604199,2.546663,2.266599,1.747864,1.588563]

volume_cc_combat =[1.4829849141376372,1.0610899633152355,0.9953280355559104,0.01458460965797137,3.236549607996947,3.2159131352514936,3.167265030866617,4.194394131100882,7.210535431982615,6.693319889179809,6.393948634647801,5.566993798764432,3.0575636766751995,2.2969013537133005,2.4206714284452118,-6.653578174681591,0.10203737273258362,-0.36348880032666164,0.5605133162417522,-0.4398369846047072,17.89484173841304,17.90109284646463,0.08580478407794034,1.8255204898436777,2.886258350014068,2.056308599283118,7.958305450504174,16.278446147345395,27.416734536518433,12.901877091643588,1.6183812242313556,20.690034812366378,0.18788693980877724,0.8919062552001735,0.7534269723598626,1.044583031129417,0.07651186774359653,0.9613795086043151,0.05741381030162662,0.45885631058330123,0.14330144772876707,-1.1078179383525355,10.318821438967893,11.908439122465698,8.206733832396447,8.176404071061272,11.651672125284225,10.703390947858408,16.473544333583735,2.1791954113089185,1.3816445626237606,1.2476729251697654,-0.17267827671310743,0.7852412686190133,-0.38887136498279107,1.8496031086328628,1.7482553446298637,12.16355525839675,14.905379144431748,7.295937233506796,6.575541495918511,6.473863515704423,15.50407444825639,0.9368578245856942,2.176195492012942,2.434982596751855,2.6606198947393915,2.15122583476421,5.984199408091067,2.7945908204366705,-1.2035049318079527,0.33878026012326057,0.5108687613392635,-2.678610980527371,2.214959755919417,1.8268368601784313,0.3320784510760628,0.28784434859451524,4.726816875966845,0.8546708862414025,1.6485374621846396,0.493621471129559,1.5903039897820155,1.6498973291826653,1.8510442147097392,-0.07865406735404123,-0.15720397902699146,39.154182715281955,5.571440268523689,5.595269362593352,5.351162444198852,6.705699410526663,5.8300654878007805,5.19232302042807,8.854650518630557,4.963448992068617,9.399437364826458,7.395243398048919,3.3620236439944566,3.2392228708708264,3.599835757284662,6.068911067054698,-0.5101974681733306,0.000861749293057823,-0.11176373099966286,-0.11532293600481269,-0.11385272298199967,0.5593342529795637,0.8938867630064418,2.322991288374703,1.0394938205128739,0.3685482092159713,0.7291821054791128,0.6395173315452078,0.46887099149618816,1.7978863569685104,1.9734183930995612,3.1740581677633575,1.8300250889702645,4.2066206976079386,3.668194661567541,2.7575561140509652,0.2668203803962861,0.25319734221945867,3.91864011074911,3.53768923207482,0.8592895769049811,3.7906528265966135,10.164499811528376,8.878806415351656,1.950063776445777,1.8952208693424804,1.4268907834523086,6.101939358299921,6.05643151177344,0.34679485287624257,3.932005888093171,1.1367131446898289,1.5594714679727746,1.7042628284973667,1.6639434657609868,1.4676832373410083,1.1041699057267422,0.992536682006453]

volume_cc_aorta = [0.9777789917468955,-0.15415886413131608,1.5631376654821882,1.5987287184439194,2.325894533651442,2.3097844744097884,2.2718068678051333,4.637024806975854,1.5972849583362998,4.662167386813065,7.7594289676427515,0.2456306318670567,0.4609722076998417,0.9513353819768553,0.06241558910304246,0.24992386635174668,1.97704885044025,2.761326532420523,1.3764767289215878,3.0552315603669324,21.409868692048466,19.29807978426654,3.8282799979931728,-0.7534571705984097,2.247391774102943,1.4872407635558091,6.522072024777347,11.2963055904787,20.197124510340718,15.810377187968939,3.2900002436523246,7.459653865736831,3.074021818777423,0.9527690988992163,1.3616427814865797,1.9365907573157313,-0.5446098899693914,1.534859763725346,0.7063475655791587,2.4027750859990036,-0.16546968064380652,-0.0875565653531134,11.9191576375285,10.57104654453775,7.96070465596271,10.298535882189634,19.196240029363018,16.137322279617607,14.611460100449374,0.581320042355983,0.9160945066069046,0.5932157406280134,2.253581935671539,2.7651648383605574,2.1895674946999915,2.852376343976604,5.09519490769575,16.884082843538213,7.298432014269139,13.450686966005275,9.41668228766668,15.143179319155266,8.23921790631208,1.8815702833933416,1.740065515435051,2.6074221066376975,4.463238186621498,0.7489282336737264,-1.3980311912503907,0.9861211667711647,0.6078894812021174,-1.5112213930823626,1.5457599035038534,1.820508208148731,0.5098563909732552,1.377771075056259,1.265721206834307,-1.870485153885197,-0.015732899538125178,4.831077582148797,2.635422638222261,3.1303831508139326,1.1324800299732458,-1.0166941733232142,0.365465371698277,2.1261655513149282,0.4572438999393986,25.535805396606527,4.6133186725478215,1.8130503890211171,3.7806331908732838,3.5588104190720986,2.6922097543694754,0.8102989393634012,10.677130929759588,7.749508702785491,5.6647024616292985,8.588352257921153,2.8158003207010056,5.058954978273055,3.156169271311192,10.919211158103629,2.3349570738832055,2.4426247440652737,0.4802714462902258,0.08588041528103751,1.175548299701179,0.49287238322544846,0.4102763502762059,2.4210774828424606,-1.0057252851957128,2.19836075552813,0.7390198577003284,3.5600908452497677,3.751837722020337,-0.9568083274509678,1.5891620477195332,3.2368096081439455,-0.8761931893345491,-0.09176284578068783,1.3024542336437537,3.755074344297968,-1.8957529082188551,2.316756390654737,0.86030211177123,-0.6036812370814375,-0.6526969054619198,-0.4392432754886548,18.221308663666452,15.050943557097913,2.4690060941638787,6.489343789090098,2.500768319414621,2.3659369507806725,2.719200633266645,0.8222932933645097,3.1548443981922416,4.713804137267471,0.6005148576574308,2.2463324721534557,2.182115580419277,3.005876960131517,1.233068134671369,1.1455897899774419]


pixelspacing = [1.126271,0.87349,0.688554,0.732727,0.869412,0.617981,0.684933,0.774426,0.551223,0.881672,0.961876,0.839361,1.067871,0.971283,1.179405,0.833148,0.821233,0.688554,0.516133,1.126271,0.927357,0.923157,1.192092,1.301931,0.84114,1.09406,1.039929,1.053334,0.494403,0.656323,0.751539,0.531941,0.8532,0.976004,0.69582,0.952764,0.728994,0.597553,0.670552,0.952764,1.192092,0.778274,1.192092,1.126271,0.974196,1.192092,0.617981,0.845152,1.03548,0.649266,0.635267,0.681324,1.192092,1.379477,1.000232,1.192092,0.789876,0.617981,0.670552,0.617981,0.740222,0.666981,0.621419,0.617981,0.782133,0.531941,0.476151,0.617981,0.786,0.706792,1.192092,1.192092,1.192092,1.192092,0.762939,1.192092,1.062317,1.048857,1.017781,0.81728,0.829167,0.987172,0.869412,0.485234,0.87349,0.952764,1.135559,0.952764,0.59082,0.885778,0.688554,1.004604,0.944258,0.927357,1.192092,1.192092,1.192092,1.192092,1.192092,1.192092,1.117018,1.009369,0.8532,0.894017,0.706792,0.849171,0.69582,0.429154,0.368519,0.476151,0.617981,0.631791,1.071338,1.192092,0.952764,0.611134,0.770587,0.587468,0.944258,1.071338,0.931568,1.075863,0.914784,1.144885,1.053334,0.677724,0.75913,0.774426,1.087738,0.952764,1.084944,1.112408,1.126271,1.192092,1.071338,1.192092,1.084944,0.931568,0.918966,1.008989,0.944258,0.995869,0.793762,0.927357]


data = pd.read_csv("combat_data.csv", header = 0)
columns = data["0"] #save the header for plotting
data = data.drop(columns = "0", axis =1)

p_data = pd.read_csv("original.csv", header = 0)
p_data = p_data.drop(columns = "0", axis =1) #removed extra patients and features

a_data = pd.read_csv("aorta_combat_data.csv", header = 0)
a_data = a_data.drop(columns = "0", axis =1) #removed extra patients and features

#volume = p_data.iloc[18]
volume = data.iloc[18]
p_volume = p_data.iloc[18]
a_volume = a_data.iloc[18]

r_value = []
#print(columns)
#print(type(columns))
#square=3
for index, feature in columns.items():
    print("plotting",index,"......")

    #plot scatter graph
    plt.figure()
    fig, axis = plt.subplots(1, 2,figsize=(15, 7))
    axis[0].scatter(volume, data.iloc[index], s=2, c='r',label = "ComBat")
    axis[0].scatter(a_volume, a_data.iloc[index], s=2, c='b', label = "Aorta Combat")
    axis[0].scatter(p_volume, p_data.iloc[index], s=2, c='grey', label = "Original")

    x = np.linspace(min(volume), max(volume), 1000)
    #find best fit line
    coefs=poly.polyfit(volume,data.iloc[index], 1)
    ffit = poly.Polynomial(coefs)
    axis[0].plot(x, ffit(x), c = "r", linewidth=1)
    #axis.text(0.5,0.9, 'y = ' + '{:.2f}'.format(coefs[0]) + ' + {:.2f}'.format(coefs[1]) + 'x', c = "r", fontsize=15, transform=axis.transAxes)
    corr_matrix = np.corrcoef(volume, data.iloc[index])
    corr = corr_matrix[0,1]
    R_sq1 = corr**2
    t =axis[0].text(0.1,0.9, r'$R^2=${:.4f}'.format(R_sq1), c = "r", fontsize=10, transform=axis[0].transAxes)
    t.set_bbox(dict(facecolor='white', alpha=0.7, edgecolor='white'))


    x = np.linspace(min(p_volume), max(p_volume), 1000)
    coefs=poly.polyfit(p_volume, p_data.iloc[index], 1)
    ffit = poly.Polynomial(coefs)    # instead of np.poly1d
    axis[0].plot(x, ffit(x), c = "grey", linewidth=1)
    #axis.text(0.5,0.8, 'y = ' + '{:.2f}'.format(coefs[0]) + ' + {:.2f}'.format(coefs[1]) + 'x', c = "b", fontsize=15, transform=axis.transAxes)
    corr_matrix = np.corrcoef(p_volume, p_data.iloc[index])
    corr = corr_matrix[0,1]
    R_sq2 = corr**2
    t =axis[0].text(0.1,0.7, r'$R^2=${:.4f}'.format(R_sq2), c = 'grey', fontsize=10, transform=axis[0].transAxes)
    t.set_bbox(dict(facecolor='white', alpha=0.7, edgecolor='white'))


    x = np.linspace(min(a_volume), max(a_volume), 1000)
    coefs=poly.polyfit(a_volume,a_data.iloc[index], 1)
    ffit = poly.Polynomial(coefs)    # instead of np.poly1d
    axis[0].plot(x, ffit(x), c = "b", linewidth=1)
    #axis.text(0.5,0.8, 'y = ' + '{:.2f}'.format(coefs[0]) + ' + {:.2f}'.format(coefs[1]) + 'x', c = "b", fontsize=15, transform=axis.transAxes)
    corr_matrix = np.corrcoef(a_volume, a_data.iloc[index])
    corr = corr_matrix[0,1]
    R_sq3 = corr**2
    t=axis[0].text(0.1,0.8, r'$R^2=${:.4f}'.format(R_sq3), c = 'b', fontsize=10, transform=axis[0].transAxes)
    t.set_bbox(dict(facecolor='white', alpha=0.7, edgecolor='white'))


    axis[1].scatter(volume_cc_combat, data.iloc[index], s=2, c='r',label = "ComBat")
    axis[1].scatter(volume_cc_aorta, a_data.iloc[index], s=2, c='b', label = "Aorta Combat")
    axis[1].scatter(volume_cc, p_data.iloc[index], s=2, c='grey', label = "Original")

    x = np.linspace(min(volume_cc_combat), max(volume_cc_combat), 1000)
    #find best fit line
    coefs=poly.polyfit(volume_cc_combat,data.iloc[index], 1)
    ffit = poly.Polynomial(coefs)
    axis[1].plot(x, ffit(x), c = "r", linewidth=1)
    #axis.text(0.5,0.9, 'y = ' + '{:.2f}'.format(coefs[0]) + ' + {:.2f}'.format(coefs[1]) + 'x', c = "r", fontsize=15, transform=axis.transAxes)
    corr_matrix = np.corrcoef(volume_cc_combat, data.iloc[index])
    corr = corr_matrix[0,1]
    R_sq1 = corr**2
    t =axis[1].text(0.1,0.9, r'$R^2=${:.4f}'.format(R_sq1), c = "r", fontsize=10, transform=axis[1].transAxes)
    t.set_bbox(dict(facecolor='white', alpha=0.7, edgecolor='white'))


    x = np.linspace(min(volume_cc), max(volume_cc), 1000)
    coefs=poly.polyfit(volume_cc,p_data.iloc[index], 1)
    ffit = poly.Polynomial(coefs)    # instead of np.poly1d
    axis[1].plot(x, ffit(x), c = "grey", linewidth=1)
    #axis.text(0.5,0.8, 'y = ' + '{:.2f}'.format(coefs[0]) + ' + {:.2f}'.format(coefs[1]) + 'x', c = "b", fontsize=15, transform=axis.transAxes)
    corr_matrix = np.corrcoef(volume_cc, p_data.iloc[index])
    corr = corr_matrix[0,1]
    R_sq2 = corr**2
    t =axis[1].text(0.1,0.7, r'$R^2=${:.4f}'.format(R_sq2), c = 'grey', fontsize=10, transform=axis[1].transAxes)
    t.set_bbox(dict(facecolor='white', alpha=0.7, edgecolor='white'))


    x = np.linspace(min(volume_cc_aorta), max(volume_cc_aorta), 1000)
    coefs=poly.polyfit(volume_cc_aorta,a_data.iloc[index], 1)
    ffit = poly.Polynomial(coefs)    # instead of np.poly1d
    axis[1].plot(x, ffit(x), c = "b", linewidth=1)
    #axis.text(0.5,0.8, 'y = ' + '{:.2f}'.format(coefs[0]) + ' + {:.2f}'.format(coefs[1]) + 'x', c = "b", fontsize=15, transform=axis.transAxes)
    corr_matrix = np.corrcoef(volume_cc_aorta, a_data.iloc[index])
    corr = corr_matrix[0,1]
    R_sq3 = corr**2
    t=axis[1].text(0.1,0.8, r'$R^2=${:.4f}'.format(R_sq3), c = 'b', fontsize=10, transform=axis[1].transAxes)
    t.set_bbox(dict(facecolor='white', alpha=0.7, edgecolor='white'))
    #r_value.append((R_sq1,R_sq3,R_sq2))

    axis[0].set_title(feature, fontsize=12)
    axis[0].legend(loc='upper right')
    axis[0].set_xlabel("Voxel Volume")

    axis[1].set_title(feature, fontsize=12)
    axis[1].legend(loc='upper right')
    axis[1].set_xlabel("Volume(cc)")

    plt.savefig("/media/sf_research/krishni/code/output/20221205volume_after_combat/"+str(index)+str(feature)+".png")
    print("graph plotted:",index)

#df = pd.DataFrame(r_value, columns =['Combat',"Aorta_Combat","Original"],index = columns)
#df.to_csv('r_value.csv', index=True, header=True, sep=',')
